# 数据库实验
## 实验一
1、PostgreSQL 安装
[Windows](https://www.yiibai.com/postgresql/install-postgresql.html)
[Linux](https://www.cnblogs.com/freeweb/p/8006639.html)


2、创建数据库和表  
使用SQL语句，完成创建一个数据库，创建关系。

&emsp;1）创建数据库scDB；

&emsp;2）按要求创建四个表：  
&emsp;&emsp;Student(Sno,Sname,Ssex,Sage,Sdept)  
&emsp;&emsp;Course(Cno,Cname,Cpno,Ccredits)  
&emsp;&emsp;SC(Sno,Cno,Grade)

&emsp;3）为属性选择合适的域、合适的主码和外键约束；

3、运行脚本SPJ.sql
```
\i your_Path
```
4、简单单表查询  

&emsp;在SPJ的基础上，完成教材第三章习题5。

## 实验二
掌握SELECT/SELECT DISTINCT/WHERE/AND/OR/ORDER BY/INSERT INTO/UPDATE/DELETE等操作

5、查询操作

  1）在零件表的视图中找出weight < 20 的零件名字(PNAME)  
  2）查询供应商表中城市为北京的供应商姓名(SNAME)  
  3）在零件表中查询平均重量在15以上的零件名字和零件代码（PNO）  
  4）查询全体供应商的姓名（SNAME）和状态(STATUS)  
  5）查询所有weight在13到20岁（含13和20）的零件代码（PNO）、零件名（PNAME）和颜色(COLOR)  
  6）查询所有“螺”开头的的零件代码（PNO）和零件名（PNAME）  
  7）查询所有零件的平均重量  
  8）查询同在“天津”的工程项目名（JNAME）  
  9）查询在“精益”供应商下的零件，且质量小于15的零件详细信息  


## 实验三  
练习带连接的子查询操作  

6、复杂子查询操作

  1）在零件表中找出weight排名前三的零件名字(PNAME)，按降序输出  

```sql
select p.pname from p order by weight desc limit 3 offset 0;
  pname   
----------
 凸轮    
 齿轮    
 螺栓    
(3 rows)
```

  2）查询至少使用了供应商S1所供应的全部零件的城是(CITY)  

?? not solved:

天津是对应2个工程的，if这两个工程分别用了p1和p2，用这种方法是没法输出天津的

```sql
 select j.city 
 from j, spj A  
 where j.jno = A.jno 
 and not exists(
     select * 
     from spj B  
     where B.sno = 'S1' 
     and not exists (
         select * from spj where A.pno = B.pno)
 );
 
 city 
------
(0 rows)
```

  3）查询出供应商代码（SNO）为S1的，生产零件的全部颜色（COLOR）  

```sql
select p.color from p,spj where spj.sno = 'S1' and spj.pno = p.pno; 
 color 
-------
 红 
 红 
 红 
 绿 
(4 rows)
```

  4）查询所有WEIGHT > 20的零件名字(PNAME),零件代码(PNO),供应商代码(SNO)，供应商姓名(SNAME)  

```sql
 select distinct spj.pno, spj.sno, s.sname from spj, s, p where p.weight > 20 and spj.pno = p.pno and spj.sno = s.sno; 
 pno | sno |   sname   
-----+-----+-----------
 P5  | S4  | 丰泰盛   
 P6  | S5  | 为民    
 P5  | S2  | 盛锡    
 P6  | S4  | 丰泰盛   
(4 rows)
```

  5）查询供应工程J1零件为红色的供应商号码(SNO)  

```sql
select distinct sno from spj, p where p.color = '红' and spj.pno = p.pno and spj.jno = 'J1';
 sno 
-----
 S1
 S3
(2 rows)
```

**Wrong:** if join s, will be:

```sql
select distinct s.sno from s, spj, p where p.color = '红' and spj.pno = p.pno and spj.jno = 'J1';
 sno 
-----
 S1
 S2
 S3
 S4
 S5
(5 rows)
```

mistake: need to `s.sno =spj.sno`

## 实验四
练习带分组聚集的查询

7、带分组聚集的查询操作

  1）查询大于平均WEIGHT的零件，列出他们的供应商代码（SNO），零件代码（PNO），工程代码（JNO），供应数量（QTY）  

Way1: 

```sql
select pno, sno, jno, qty from spj where pno in (select pno from p where weight > (select avg(weight) from p));

 pno | sno | jno 
-----+-----+-----
 P5  | S2  | J1
 P5  | S2  | J2
 P5  | S4  | J1
 P6  | S4  | J3
 P6  | S4  | J4
 P6  | S5  | J2
 P6  | S5  | J4
```

Way 2:

```sql
select pno into a from p where p.weight > (select avg(weight) from p);
select spj.pno, sno, jno, qty from spj, a where a.pno = spj.pno;
```

  

2）查询小于平均供应数量QTY的零件，列出他们的零件代码（PNO），零件名（PNAME），颜色（COLOR）  

??Way 1:

```sql
select p.pno, pname, color from p, spj where p.pno = spj.pno and spj.qty < (select avg(qty) from spj);
 pno |   pname   | color 
-----+-----------+-------
 P1  | 螺母      | 红 
 P1  | 螺母      | 红 
 P2  | 螺栓      | 绿 
 P3  | 螺丝刀    | 蓝 
 P5  | 凸轮      | 蓝 
 P1  | 螺母      | 红 
 P3  | 螺丝刀    | 蓝 
 P5  | 凸轮      | 蓝 
 P6  | 齿轮      | 红 
 P2  | 螺栓      | 绿 
 P3  | 螺丝刀    | 蓝 
 P6  | 齿轮      | 红 
(12 rows)
```

Way 2:

```sql
select p.pno, pname, color from p, spj where p.pno = spj.pno and spj.qty < (select avg(qty) from spj) group by p.pno;
 pno |   pname   | color 
-----+-----------+-------
 P6  | 齿轮      | 红 
 P5  | 凸轮      | 蓝 
 P3  | 螺丝刀    | 蓝 
 P2  | 螺栓      | 绿 
 P1  | 螺母      | 红 
(5 rows)
```

Way 3:

```sql
select pno, pname, color from p where pno in (select pno from spj group by (pno,qty) having spj.qty < (select avg(qty) from spj));
 pno |   pname   | color 
-----+-----------+-------
 P1  | 螺母      | 红 
 P2  | 螺栓      | 绿 
 P3  | 螺丝刀    | 蓝 
 P5  | 凸轮      | 蓝 
 P6  | 齿轮      | 红 
(5 rows)
```

  3）查询供应数量QTY不在99-301之间的零件，列出他们的零件代码（PNO），零件名（PNAME），颜色（COLOR）  

```sql
select p.pno, pname, color from spj, p where p.pno = spj.pno and spj.qty not between 99 and 301 group by p.pno;
 pno |   pname   | color 
-----+-----------+-------
 P5  | 凸轮      | 蓝 
 P6  | 齿轮      | 红 
 P3  | 螺丝刀    | 蓝 
 P1  | 螺母      | 红 
(4 rows)
```

  4）查询WEIGHT大于15，且供应数量QTY必须在250以上的零件，列出他们的零件代码（PNO），零件名（PNAME）,供应数量（QTY）  

```sql
 select p.pno, p.pname, p.color from p, spj where spj.pno = p.pno and p.weight > 15 and spj.qty >250 group by p.pno;
 pno |  pname   | color 
-----+----------+-------
 P6  | 齿轮     | 红 
 P5  | 凸轮     | 蓝 
(2 rows)
```



  5）查询工程项目代码（JNO）为“J1”的项目，列出所有使用的零件代码（PNO），零件名（PNAME）,颜色（COLOR）  

```sql
select p.pno, p.pname, spj.qty from p, spj where spj.jno = 'J1' and p.pno = spj.pno group by p.pno, spj.qty;
 pno |   pname   | qty 
-----+-----------+-----
 P1  | 螺母      | 200
 P3  | 螺丝刀    | 200
 P3  | 螺丝刀    | 400
 P5  | 凸轮      | 100
 P5  | 凸轮      | 400
(5 rows)

select p.pno, p.pname, spj.qty from p, spj where spj.jno = 'J1' and p.pno = spj.pno group by p.pno, spj.qty, sno;
 pno |   pname   | qty 
-----+-----------+-----
 P1  | 螺母      | 200
 P1  | 螺母      | 200
 P3  | 螺丝刀    | 200
 P3  | 螺丝刀    | 200
 P3  | 螺丝刀    | 400
 P5  | 凸轮      | 100
 P5  | 凸轮      | 400
(7 rows)
```

??groupby?

  6）查询供应商代码（SNO），零件代码（PNO），重量（WEIGHT），通过零件代码（PNO），重量（WEIGHT）排序

```sql
select distinct spj.sno, spj.pno, p.weight from spj, p where spj.pno = p.pno order by  spj.pno, p.weight;
 sno | pno | weight 
-----+-----+--------
 S1  | P1  |     12
 S3  | P1  |     12
 S1  | P2  |     17
 S5  | P2  |     17
 S2  | P3  |     14
 S3  | P3  |     14
 S5  | P3  |     14
 S2  | P5  |     40
 S4  | P5  |     40
 S4  | P6  |     30
 S5  | P6  |     30
(11 rows)
```



### Tips:
>\password           设置密码。  
 q                  退出。  
 h                  查看SQL命令的解释，比如\h select    
 l                  列出所有数据库。  
 c [database_name]  连接其他数据库。  
 d                  列出当前数据库的所有表格。  
 d [table_name]     列出某一张表格的结构。  
 du                 列出所有用户。  
 e                  打开文本编辑器。  
 conninfo           列出当前数据库和连接的信息。  
 \?                  查看psql命令列表
